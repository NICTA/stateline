## Overview
Stateline is a framework for distributed Markov Chain Monte Carlo (MCMC) sampling written in C++11. It focuses on [parallel tempering](http://en.wikipedia.org/wiki/Parallel_tempering) methods which are highly parallelisable.

## System Support
Currently, Stateline runs on Linux-based operating systems only.

## Compiler Support
Stateline has been compiled and tested under g++ 4.8.2.

## Prerequisites
Stateline requires the following libraries as prerequisites:

* Boost 1.55
* Eigen 3.2.0
* google-log (glog) 0.3.3
* google-test (gtest) 1.7.0
* zeromq 4.0.3
* cppzeromq 2358037407 (commit hash)
* nlohmann json (commit 58d7342)

## Building
The simplest way to get Stateline running is to run the `fetch-all.sh` script in the project root directory:

```bash
$ git clone https://github.com/NICTA/stateline.git
$ cd stateline
$ ./tools/fetch-deps && ./tools/build debug
$ cd build/debug && make
```

This will automatically download and build the necessary dependencies into a build folder. It will also create and configure a folders for a debug build. More information about building can be found [here](https://github.com/NICTA/stateline/wiki/Installation-Guide).

## Example C++ Code
This is a quick example showing the Stateline C++ API to sample from a Gaussian distribution. You can read a (link)tutorial on how to build and run this code.

## Server
```cpp
#include "stateline/server.hpp"
#include "stateline/csv.hpp"

#include <iostream>

namespace sl = stateline;

int main(int ac, char *av[])
{
  // Use the default settings with 4 chains
  auto settings = sl::StatelineSettings::fromDefault(4);

  // Initialise a server on port 5555
  sl::Server server{5555, settings};
  
  std::cout << "Collecting 1000 samples from each chain" << std::endl;
  auto samples = server.step(1000);
  
  // Save the samples from each chain to a CSV file in a folder called demo-samples
  sl::saveToCSV("demo-samples", samples);

  return 0;
}
```

## Worker
```cpp
#include "stateline/worker.hpp"

double gaussianNLL(const std::string& jobType, const std::vector<double>& x)
{
  double squaredNorm = 0.0;
  for (auto i : x)
  {
    squaredNorm += i * i;
  }
  return 0.5 * squaredNorm;
}

int main(int argc, char *argv[])
{
  // Only 1 job type for this demo
  std::vector<std::string> jobTypes = { "job" };
  
  // Initialise a worker with the our likelihood function and use 4 threads.
  // Blocks until the worker is no longer needed.
  stateline::runWorker(gaussianNLL, "localhost:5555", jobTypes, 4);

  return 0;
}
```

Running C++ Demo
----------------
To see Stateline in action, open two terminals and run the following commands in a build directory:

Run the Stateline server in Terminal 1:

```bash
$ ./stateline --config=cpp-demo-config.json
```

Run a Stateline worker in Terminal 2:

```bash
$ ./demo-worker
```

Now, in your build directory, you should see a folder called cpp-demo-chains. This folder contains samples from the demo MCMC. Running

```bash
$ python vis.py cpp-demo-output/0.csv
```

will launch a Python script that visualises the samples of the first chain. You'll need NumPy and the excellent [triangle-plot](https://github.com/dfm/triangle.py) module.

Running Python Demo
-------------------
There is also a demo in Python, which shows how workers written in other languages can interact with the Stateline server. Again, open two terminals and run the following commands in a build directory:

Run the Stateline server in Terminal 1:

```bash
$ ./stateline --config=python-demo-config.json
```

Run a Stateline worker in Terminal 2:

```bash
$ python demo-worker.py
```

And again, running

```bash
$ python vis.py python-demo-output/0.csv
```

will launch a Python script that visualises the samples of the first chain.

Documentation
-------------
Documentation can be found in the
[wiki](http://github.com/NICTA/stateline/wiki), and there is automatic doxygen documentation generated by running

```bash
$ make doc
```

in a build directory. Please ensure Doxygen is installed. Finally, there are demos for python and C++ in the src/bin folder.

Licence
-------
Please see the LICENSE file, and COPYING and COPYING.LESSER.

Bug Reports
-----------
If you find a bug, please open an [issue](http://github.com/NICTA/stateline/issues).

Contributing 
------------
Contributions and comments are welcome. Please read our [style guide](docs/CodeGuidelines.md) before submitting a pull request.
